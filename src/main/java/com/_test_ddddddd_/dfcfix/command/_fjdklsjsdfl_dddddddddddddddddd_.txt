







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































// 放在文件头的 imports（若已经有则不用重复）
import net.minecraft.command.ICommandSender;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.tileentity.TileEntity;
import net.minecraft.util.math.BlockPos;
import net.minecraft.block.state.IBlockState;
import net.minecraft.util.text.TextComponentString;
import net.minecraft.world.World;
import com.hbm.tileentity.machine.TileEntityCore;

// 替换为下面这个方法（放在类里）
private void handleSet_2_(ICommandSender sender, int x, int y, int z, int fuelMax) {
    World world = sender.getEntityWorld();
    BlockPos pos = new BlockPos(x, y, z);

    TileEntity teRaw = world.getTileEntity(pos);
    if (!(teRaw instanceof TileEntityCore)) {
        sender.addChatMessage(new TextComponentString("No core at " + pos));
        return;
    }

    TileEntityCore te = (TileEntityCore) teRaw;

    try {
        // 1) 写入 NBT（持久化）
        NBTTagCompound data = te.getTileData();
        data.setInteger("fuelMax", fuelMax);   // 用于每次 drain 限制
        data.setInteger("tankCap", fuelMax);   // 同步存 tank 容量（可选）
        te.markDirty();

        // 2) 通知区块更新，强制客户端刷新显示
        IBlockState state = world.getBlockState(pos);
        world.notifyBlockUpdate(pos, state, state, 3);

        // 3) 尝试调用工具类（优先）
        try {
            UtilsDFCFix.applyTankCapRealtime((Object) te, world, pos, fuelMax);
        } catch (NoClassDefFoundError e) {
            // UtilsDFCFix 不存在 -> 走内联回退（best-effort）
            try {
                // 反射取 tanks 数组（常见字段名）
                Object[] tanksArr = null;
                String[] tankFieldNames = new String[] {"tanks", "fluidTanks", "tankArray"};
                for (String name : tankFieldNames) {
                    try {
                        java.lang.reflect.Field f = te.getClass().getDeclaredField(name);
                        f.setAccessible(true);
                        Object arr = f.get(te);
                        if (arr != null) {
                            int len = java.lang.reflect.Array.getLength(arr);
                            tanksArr = new Object[len];
                            for (int i = 0; i < len; i++) tanksArr[i] = java.lang.reflect.Array.get(arr, i);
                        }
                        break;
                    } catch (NoSuchFieldException ignore) {}
                }

                if (tanksArr != null) {
                    for (Object tank : tanksArr) {
                        if (tank == null) continue;
                        // 优先处理官方 Forge FluidTank（反射，不用在编译期 import）
                        boolean applied = false;
                        try {
                            Class<?> forgeTankCls = Class.forName("net.minecraftforge.fluids.FluidTank");
                            if (forgeTankCls.isAssignableFrom(tank.getClass())) {
                                try {
                                    java.lang.reflect.Field capField = forgeTankCls.getDeclaredField("capacity");
                                    capField.setAccessible(true);
                                    capField.setInt(tank, fuelMax);
                                } catch (NoSuchFieldException ignore) {}
                                // 截断 FluidStack.amount（如果存在）
                                try {
                                    java.lang.reflect.Method getFluid = forgeTankCls.getMethod("getFluid");
                                    Object fs = getFluid.invoke(tank);
                                    if (fs != null) {
                                        Class<?> fsCls = Class.forName("net.minecraftforge.fluids.FluidStack");
                                        try {
                                            java.lang.reflect.Field amtF = fsCls.getDeclaredField("amount");
                                            amtF.setAccessible(true);
                                            int now = amtF.getInt(fs);
                                            if (now > fuelMax) {
                                                java.lang.reflect.Method getFluidMeth = fsCls.getMethod("getFluid");
                                                Object fluidObj = getFluidMeth.invoke(fs);
                                                Object newFs = fsCls.getConstructor(fluidObj.getClass(), int.class).newInstance(fluidObj, fuelMax);
                                                java.lang.reflect.Method setFluid = forgeTankCls.getMethod("setFluid", fsCls);
                                                setFluid.invoke(tank, newFs);
                                            }
                                        } catch (NoSuchFieldException nf) {}
                                    }
                                } catch (NoSuchMethodException ignore) {}
                                applied = true;
                            }
                        } catch (ClassNotFoundException cnf) {
                            // Forge FluidTank 不存在 -> 继续通用反射
                        } catch (Throwable t) {
                            t.printStackTrace();
                        }

                        if (applied) {
                            System.out.println("[DFCFIX CMD] applied Forge FluidTank capacity -> " + fuelMax + " on " + tank.getClass().getName());
                            continue;
                        }

                        // 通用反射（尝试 setter 或字段）
                        Class<?> cls = tank.getClass();
                        String[] capSetters = new String[] {"setCapacity", "setMaxFill", "setMax", "setMaxAmount", "setCapacityMB"};
                        String[] capFields = new String[] {"capacity", "maxFill", "max_fill", "maxFillAmount", "max", "maxAmount"};
                        for (String mname : capSetters) {
                            try {
                                java.lang.reflect.Method m = cls.getMethod(mname, int.class);
                                m.setAccessible(true);
                                m.invoke(tank, fuelMax);
                                applied = true;
                                break;
                            } catch (NoSuchMethodException ignore) {}
                        }
                        if (!applied) {
                            for (String fname : capFields) {
                                try {
                                    java.lang.reflect.Field ff = cls.getDeclaredField(fname);
                                    ff.setAccessible(true);
                                    ff.setInt(tank, fuelMax);
                                    applied = true;
                                    break;
                                } catch (NoSuchFieldException ignore) {}
                            }
                        }

                        // 截断当前量（getFill/setFill 或字段）
                        try {
                            Integer now = null;
                            try {
                                java.lang.reflect.Method gm = cls.getMethod("getFill");
                                Object v = gm.invoke(tank);
                                if (v instanceof Integer) now = (Integer) v;
                            } catch (NoSuchMethodException ignore) {}
                            if (now != null && now > fuelMax) {
                                try {
                                    java.lang.reflect.Method sm = cls.getMethod("setFill", int.class);
                                    sm.setAccessible(true);
                                    sm.invoke(tank, fuelMax);
                                } catch (NoSuchMethodException ignore) {
                                    String[] altAmt = new String[] {"amount", "fill", "fluidAmount"};
                                    for (String af : altAmt) {
                                        try {
                                            java.lang.reflect.Field f = cls.getDeclaredField(af);
                                            f.setAccessible(true);
                                            f.setInt(tank, fuelMax);
                                            break;
                                        } catch (NoSuchFieldException ignore2) {}
                                    }
                                }
                            }
                        } catch (Throwable tt) {
                            tt.printStackTrace();
                        }

                        System.out.println("[DFCFIX CMD] attempted apply to tank class " + tank.getClass().getName() + " cap=" + fuelMax);
                    } // for tanks
                } else {
                    System.out.println("[DFCFIX CMD] tanks array not found for " + pos);
                }
            } catch (Throwable inlErr) {
                inlErr.printStackTrace();
            }
        } catch (Throwable e) {
            // UtilsDFCFix 存在但运行中抛了异常 -> 打印并继续，不阻塞命令
            e.printStackTrace();
        }

        // 反馈
        sender.addChatMessage(new TextComponentString("Set fuelMax=" + fuelMax + " at " + pos));
        System.out.println("[DFCFIX CMD] set fuelMax=" + fuelMax + " at " + pos);

    } catch (Throwable ex) {
        ex.printStackTrace();
        sender.addChatMessage(new TextComponentString("Error applying fuelMax: " + ex.getMessage()));
    }
}
